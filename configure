#!/bin/sh

# Determine target architecture
TARGET=`rustc --version 2> /dev/null | awk '/host:/ { FS = " "; print $2 }'`

# Update dependencies from git
# $1: git
#     The git uri from which to download the dependency
# $2: name (usually the git repo name)
#     The name under which the dependency will be stored
# $3: build location
#     The location to which the git builds (omit trailing '/')
# $4: build command
#     The argument to pass to make (not required)
updateDependency () {
  # Clear this dependency's folder if it exists already.
  if [ -d deps/$2 ]; then
      rm -rf deps/$2
  fi
# Fetch local copy
  git clone $1 deps/$2
# Build dependency
# (assumes existence of make)
  cd deps/$2
  if [ -x configure ]; then
    ./configure
  fi
  make clean
  make $4
  cd ../..
# Prepare folder structure dependency targets
  mkdir -p target/$TARGET/lib
# Copy dependency targets
# (symlinking does not work on OS X)
  cp deps/$2$3/* target/$TARGET/lib/
}

updateDependency 'https://github.com/sfackler/rust-openssl.git' 'rust-openssl' '/build'
updateDependency 'https://github.com/chris-morgan/rust-http.git' 'rust-http' '/build'
updateDependency 'https://github.com/chris-morgan/anymap.git' 'anymap' '/build'

curl http://svn.apache.org/repos/asf/httpd/httpd/trunk/docs/conf/mime.types | \
awk '{if ($1 != "#") { gsub("/"," ",$1); print $2 " " $1} }' > src/generated/mimes.txt
rustc -O -o src/generated/mimegen src/generated/main.rs
src/generated/mimegen src/generated/mimes.txt src/response/mimes/mimegen.rs
